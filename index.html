<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<title>Earthquakes JP</title>

<!-- ========================
     STYLE VISUEL (CSS)
========================= -->
<style>
  body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#0f1115;
    color:white;
  }

  /* layout gauche = carte / droite = liste */
  .app{
    display:flex;
    height:100vh;
  }

  .left{
    flex:3;
    padding:15px;
    border-right:1px solid #333;
    box-sizing:border-box;
  }

  .right{
    flex:2;
    overflow:auto;
    padding:15px;
    box-sizing:border-box;
  }

  /* card séisme */
  .item{
    border:1px solid #333;
    padding:12px;
    margin-bottom:12px;
    border-radius:12px;
    cursor:pointer;
    background:#141821;
  }

  .item:hover{
    border-color:#555;
  }

  .item.selected{
    border-color:#7aa2ff;
  }

  .muted{
    color:#aaa;
    font-size:12px;
  }

  @media (max-width: 900px){
    .app{ flex-direction:column; }
    .left{ border-right:none; border-bottom:1px solid #333; }
  }
</style>
</head>

<body>

<!-- ========================
     STRUCTURE HTML
========================= -->
<div class="app">

  <!-- ZONE CARTE (placeholder pour l'instant) -->
  <div class="left">
    <h2 style="margin:0 0 10px 0;">Carte (bientôt)</h2>
    <div id="selected" class="muted">Chargement…</div>

    <div id="map" style="margin-top:16px; height:70vh; border-radius:12px;"></div>
  </div>

  <!-- LISTE DES SÉISMES -->
  <div class="right">
    <h2 style="margin:0 0 10px 0;">30 derniers séismes</h2>
    <div id="list"></div>
  </div>

</div>

<!-- ========================
     SCRIPT JAVASCRIPT
========================= -->
<script>
let selectedId = null;

const map = L.map("map").setView([36.2, 138.2], 5);

// Fond clair japonais (GSI Pale)
L.tileLayer(
  "https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png",
  {
    attribution: "地理院タイル",
    maxZoom: 18
  }
).addTo(map);

// Couche labels internationale (anglais + JP)
L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png",
  {
    attribution: "© OpenStreetMap © CARTO",
    pane: "overlayPane"
  }
).addTo(map);  

/*
  Formate une date ISO en texte lisible.
*/
function fmtTime(s){
  try { return new Date(s).toLocaleString(); } catch { return s; }
}

/*
  Compte les stations dans TON JSON JMA:
  detail.Body.Intensity.Observation.Pref[].Area[].City[].IntensityStation[]
*/
function countStations(detail){
  const prefs = detail?.Body?.Intensity?.Observation?.Pref || [];
  let count = 0;

  for (const pref of prefs) {
    for (const area of (pref.Area || [])) {
      for (const city of (area.City || [])) {
        count += (city.IntensityStation || []).length;
      }
    }
  }
  return count;
}

function buildCityPoints(detail){
  const prefs = detail?.Body?.Intensity?.Observation?.Pref || [];
  const cities = [];

  for (const pref of prefs) {
    for (const area of (pref.Area || [])) {
      for (const city of (area.City || [])) {
        const st = (city.IntensityStation || [])[0];
        const lat = st?.latlon?.lat;
        const lon = st?.latlon?.lon;

        if (typeof lat === "number" && typeof lon === "number") {
          cities.push({
            name: city.Name,
            code: city.Code,
            intensity: city.MaxInt,
            lat, lon
          });
        }
      }
    }
  }
  return cities;
}

/*
  Compte les stations qui ont des coordonnées lat/lon.
*/
function countLatLon(detail){
  const prefs = detail?.Body?.Intensity?.Observation?.Pref || [];
  let count = 0;

  for (const pref of prefs) {
    for (const area of (pref.Area || [])) {
      for (const city of (area.City || [])) {
        for (const st of (city.IntensityStation || [])) {
          if (st.latlon && typeof st.latlon.lat === "number" && typeof st.latlon.lon === "number") {
            count++;
          }
        }
      }
    }
  }
  return count;
}

/*
  Charge events.json et affiche la liste.
*/

function updateSelectionUI(){
  document.querySelectorAll(".item").forEach(el=>{
    el.classList.remove("selected");
  });
}

async function main(){
  const listEl = document.getElementById("list");

  try{
    const res = await fetch("./events.json", { cache: "no-store" });
    if(!res.ok) throw new Error("events.json introuvable (HTTP " + res.status + ")");

    const data = await res.json();
    const events = data.events || [];

    if(events.length === 0){
      document.getElementById("selected").textContent = "Aucun séisme trouvé.";
      listEl.innerHTML = "Liste vide.";
      return;
    }

    // sélection par défaut = premier
    if(!selectedId) selectedId = events[0].id;

    listEl.innerHTML = "";

    events.forEach(ev => {
      const div = document.createElement("div");
      div.className = "item" + (ev.id === selectedId ? " selected" : "");

      div.innerHTML = `
        <div><b>M ${ev.magnitude ?? "?"}</b> | <b>Max ${ev.maxIntensity || "?"}</b></div>
        <div class="muted">${fmtTime(ev.time)}</div>
        <div style="margin-top:6px;">${ev.region || ev.title || "-"}</div>
      `;

      div.onclick = () => {
        selectedId = ev.id;

        updateSelectionUI();
        div.classList.add("selected");

        // Affichage de base
        const selectedEl = document.getElementById("selected");
        selectedEl.innerHTML =
          "<b>Séisme sélectionné:</b><br>" +
          (ev.region || ev.title || "") +
          "<br><span style='font-size:12px;color:#aaa;word-break:break-all'>" +
          ev.detailUrl +
          "</span>";

        // Mini test: charger le détail JMA et compter les stations
        fetch(ev.detailUrl)
          .then(r => r.json())
          .then(detail => {
            const stations = countStations(detail);
            const coords = countLatLon(detail);
            const cityPoints = buildCityPoints(detail);

            selectedEl.innerHTML +=
              "<br><span style='font-size:12px;color:#7CFF7C'>Stations: " + stations + "</span>" +
              "<br><span style='font-size:12px;color:#7CFF7C'>Coordonnées: " + coords + "</span>"+
              "<br><span style='font-size:12px;color:#7CFF7C'>Points ville: " + cityPoints.length + "</span>";
          })
          .catch(err => {
            selectedEl.innerHTML +=
              "<br><span style='font-size:12px;color:#FF7C7C'>Erreur detail: " + err.message + "</span>";
          });
      };

      listEl.appendChild(div);
    });

    // Afficher aussi le premier élément sélectionné (sans stats tant que pas cliqué)
    const first = events.find(e => e.id === selectedId) || events[0];
    document.getElementById("selected").innerHTML =
      "<b>Séisme sélectionné:</b><br>" +
      (first.region || first.title || "") +
      "<br><span style='font-size:12px;color:#aaa;word-break:break-all'>" +
      first.detailUrl +
      "</span>";

  } catch(e){
    document.getElementById("selected").textContent = "Erreur: " + e.message;
    listEl.innerHTML = "";
  }
}

main();
</script>
</body>
</html>
